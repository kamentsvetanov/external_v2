function varargout = dmatlicense
%DMATLICENSE  License information for DMAT
%   DMATLICENSE() prints the End User License Agreement (EULA) for DMAT.
%   You can also find this Agreement in the file 'dmateula.txt' that is
%   delivered along with DMAT.
%
%   DMATLICENSE(), if you run it for the first time, displays the EULA in a
%   pop-up window and asks you to read it and agree to it. If you do not
%   agree to the terms of the EULA, you cannot use DMAT.
%
%   AGREED = DMATLICENSE() returns 1 if you're agreed to the EULA before,
%   or 0 if you haven't.
%
%   Author: Joachim Vandekerckhove (joachim.vandekerckhove@psy.kuleuven.be)
%   Part of the DMA Toolbox. Please read the End User License Agreement,
%   contained in 'dmateula.txt' or by invoking the DMATLICENSE command. 
%   See also http://ppw.kuleuven.be/okp/dmatoolbox.

%   Edit 0.3: Updated version to 0.3.
%   Edit 0.4: Updated version to 0.4.

current = 0.4;
dm = {'dmatoolbox','version'};
registered = ispref(dm{:}) && getpref(dm{:})==current;

if nargout
    varargout{1} = registered;
else
    eula = fullfile(getpref('dmatoolbox','dmatdir'),'dmateula.txt');
    fid = fopen(eula);
    txt = textscan(fid,'%s','delimiter','\n');
    fclose(fid);
    if registered
        for l=1:numel(txt{1})
            line = parsetoline(txt{1}{l});
            if isempty(line)
                line = ' ';
            end
            disp(line)
        end
        disp(parsetoline(sprintf('\n(This text may also be found in %s)',eula)))
    else
%%        
        comm = sprintf('setpref(''dmatoolbox'',''version'',%f);',current);
        popup = figure('Name','DMAT End User License Agreement',...
            'NumberTitle','off',...
            'Toolbar','None',...    
            'Resize','off',...
            'DockControls','off',...
            'MenuBar','none',...
            'Units','normalized',...
            'WindowStyle','modal',...
            'Position',[.25 .2 .44 .7]);
        editbox = uicontrol(popup,...
            'Style','edit',...
            'Units','normalized',...
            'Min',1,...
            'Max',5,...
            'HorizontalAlignment','left',...
            'String',txt{:},...
            'FontName','fixedwidth',...
            'Position',[.05 .17 .9 .75]);
        statictext = uicontrol(popup,...
            'Style','text',...
            'Units','normalized',...
            'String',['Please read this End User License Agreement ',...
            'carefully'],...
            'FontWeight','bold',...
            'BackgroundColor',[.8 .8 .8],...
            'ForegroundColor',[1 0 0],...
            'Position',[.05 .94 .9 .03]);
        agree = uicontrol(popup,...
            'Style','PushButton',...
            'String',['Click here if you have read the entire text ',...
            'above and you accept the agreement'],...
            'Units','normalized',...
            'Position',[.05 .085 .90 .06],...
            'Callback',[comm 'close']);
        reject = uicontrol(popup,...
            'Style','PushButton',...
            'String','Click here if you do not accept the agreement',...
            'Units','normalized',...
            'Position',[.05 .015 .90 .06],...
            'Callback','close');
%%
        uiwait
    end
end