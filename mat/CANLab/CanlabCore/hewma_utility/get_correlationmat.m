function Corr = get_correlationmat(varZm,lambda,Wm,sesq);% Corr = get_correlationmat(varZm,lambda,Wm,sesq)nsub = size(varZm,1);T = size(varZm,2);varbtwn = max(0,sesq - mean(varZm)); Corr = diag(varbtwn);Wm = Wm./sum(Wm);        % weighted population meanfor s = 1:nsub,    C = diag(varZm(s,:));    for t_i=1:(T-1),            i = 1:(T - t_i);            C(t_i,(t_i+1):T) = 0.5*( (1-lambda).^i.*varZm(s,t_i) + (1-lambda).^(-i).*(varZm(s,t_i+i) - varZm(s,i)));            C((t_i+1):T,t_i) = C(t_i,(t_i+1):T);    end;    Corr = Corr + Wm(s).*C;    end;v = sqrt(diag(Corr));Corr = Corr./(v*v');return;    